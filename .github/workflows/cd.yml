# .github/workflows/cd.yml
name: CD

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Ensure remote host known
        run: |
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Pull & restart docker-compose on remote
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }} &&
            docker compose pull &&
            docker compose up -d --remove-orphans
          "

      - name: Smoke test
        run: |
          # health endpoint
          HEALTH=$(curl -sS -m 5 http://${{ secrets.DEPLOY_HOST }}:8080/health || echo "")
          if [[ "$HEALTH" != *"ok"* ]]; then
            echo "Health check failed: $HEALTH"
            exit 1
          fi
          # predict: send a blank image
          curl -X POST -s -F "file=@src/tests/sample.jpg" http://${{ secrets.DEPLOY_HOST }}:8080/predict | jq .